#! /bin/sh
#
# check tapelist against database and vice versa
#

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@

bindir=@bindir@
CONFIG_DIR=@CONFIG_DIR@

USE_VERSION_SUFFIXES="@USE_VERSION_SUFFIXES@"
if test "$USE_VERSION_SUFFIXES" = "yes"; then
	SUF="-@VERSION@"
else
	SUF=
fi

CONFIG=$1
[ "$CONFIG" = "" ] \
	&& echo "usage: $0 <config>" >&2 \
	&& exit 1

TAPELIST=$CONFIG_DIR/$CONFIG/tapelist

[ ! -f $TAPELIST ] \
	&& echo "$TAPELIST not found" >&2 \
	&& exit 1

AMADMIN=$bindir/amadmin$SUF

[ ! -x $AMADMIN ] \
	&& echo "$AMADMIN not found or not executable" >&2 \
	&& exit 1

$AMADMIN $CONFIG export \
	| grep "^stats: " \
	| while read LINE; do
		[ "$LINE" = "" ] && continue
		set $LINE
		echo $8
	done \
	| sort -u \
	| while read TAPE; do
		grep " $TAPE\$" $TAPELIST 2>/dev/null >/dev/null
		[ $? != 0 ] \
			&& echo "Tape $TAPE missing in $TAPELIST"
	done

echo "Ready."

exit 0
