This document was originally written by Daniel Moore
<dmoore@jeffco.k12.co.us>, on Jan 12, 1998.  It descripts how to
restore files backed up with amanda either with or without amanda
tools.  Comments, criticism are welcome.

I considered 6 cases.
1)  Client machine fails, non-system critical. 
2)  Client machine fails, system critical disk.
3)  Server machine fails, non-system critical, non-amanda disk.
4)  Server machine fails, system critical, non-amanda disk.
5)  Server machine fails, non-system critical, amanda disk, with db.
6)  Server machine fails, non-system critical, amanda disk, with binaries.

The server machine (machine Aaron) is solaris, the client machine 
(machine Barney) is sunos.

Cases:

1)  Client machine fails, non-system critical. 
Example: /home fails on Barney.

First, use amadmin to find the tapes most recently used to backup the 
partition.

amadmin <config> info Barney '/home$'

Current info for Barney /home:
  Stats: dump rates (kps), Full:   41.1,  33.1,  38.8
                    Incremental:    9.5,   2.1,  24.7
          compressed size, Full:  63.1%, 54.0%, 52.9%
                    Incremental:  43.7%, 15.5%, 47.8%
  Dumps: lev datestmp  tape             file   origK   compK secs
          0  19971223  Barney01           16  329947  208032 5060
          1  19980108  Barney16            8    1977     864   91
          2  19971222  Barney06            7    1874     672   83
          3  19970926  Barney03           11   12273    3040  211

This tells us that we will need four tapes to do a full restore 
(Barney01, Barney16, Barney06, and Barney03).

Log into Barney.  Cd to the /home directory.  Insert the tape with the 
level 0 dump on it into the tape drive of Aaron.

Use rsh in order to pipe the output from amrestore on the server 
machine to restore on the client machine, after su'ing to bin (the amanda 
user?) (or does the user need to be root?).

rsh -n Aaron amrestore -p /dev/rmt/0cn Barney '/home$' | restore -ivbf 2 -

Repeat until, incrementing the level of the dump, until out of tapes.
y

2)  Client machine fails, system critical disk.
Example: / fails on Barney.

First of all, boot off the CD, and reinstall the system critical
partition, restoring it to vendor supplied state.  Then, go through all of
Scenario 1. 


3)  Server machine fails, non-system critical, non-amanda disk.
Example: /var/opt on Aaron

First, use amadmin to find the tapes most recently used to backup the 
partition.

amadmin <config> info Aaron /var

Current info for Aaron /var:
  Stats: dump rates (kps), Full:  427.4, 428.8, 434.6
                    Incremental:  156.6, 258.1, 165.1
          compressed size, Full:  36.0%, 37.1%, 38.8%
                    Incremental:  14.1%, 21.3%, 15.1%
  Dumps: lev datestmp  tape             file   origK   compK secs
          0  19980107  Barney15            5   66527   23936   56
          1  19980108  Barney16           12   21055    2976   19

This tells us that we will need two tapes to do a full restore 
(Barney16 and Barney15).

Use amrestore directly, after cd'ing to /var and su'ing to root(bin?).

amrestore /dev/rmt/0cn Aaron /var


4)  Server machine fails, system critical, non-amanda disk.
Example: / on Aaron

First of all, boot off the CD, and reinstall the system critical 
partition, restoring it to vendor supplied state.

Then, follow steps in Scenario 3.


5)  Server machine fails, non-system critical, amanda disk, with db.
An example: /opt on Aaron

If the disk that the amanda database is toast, then you need to rebuild 
the database.  The easiest way to do it is to take the text file that you 
had mailed to you via the 'amadmin export' command, and import via the 
'amadmin import' command.  Then you should be able to follow the steps 
outlined in Scenario 4.

6)  Server machine fails, non-system critical, amanda disk, with binaries.
Example: /usr/local on Aaron

This is where things get hairy.  If the disk with the amanda binaries on 
it is toast, you have three options.  

i) reinstall the amanda binaries from another tape, on which you have 
conveniently backed up the binaries within the last couple of weeks (not 
using amanda).

ii) recompile amanda, making sure not to overwrite your db files.

iii) use dd to read amanda formatted tapes.  This is the option I am 
going to explore most fully, because this seems the most likely to occur.

a) Find out the device name used by amanda, by looking in amanda.conf.	
Turns out to be /dev/rmt/0cn for this system.

b) Look over the copy of the output of 'amadmin <config> export', and find
out which tapes /opt was backed up on. 

c) Grab the tapes that /opt was backed up on, and stick the level 0 into 
the drive.  cd to /opt.

d) Start at the second record, by using the appropriate tape command.

mt -f /dev/rmt/0cn fsf 2


e) Now you want to start looking for /opt on this tape.

dd if=/dev/rmt/0cn bs=32k skip=1 | gzip -d | /usr/sbin/ufsrestore -ivf -
This command gives us an interactive restore of this record, including
telling us what partition, what host, and what level the backup was.  The
gzip -d portion of the pipe can be omitted if there was no compression.

f) If you don't find /opt on the first try, quit ufsrestore, and move 
forward one record.
mt -f /dev/rmt/0cn fsf 1

and try the dd/restore command shown above.  Do this until you find /opt 
on the disk.

g) Restore the amanda binaries (what else do you need??), and then bail 
out of ufsrestore.  You can use amrestore, as in Scenario 3.
